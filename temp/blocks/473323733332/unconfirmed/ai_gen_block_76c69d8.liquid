{% doc %}
  @prompt
    "Create a new product section block named 'Live Personalization Preview.' The entire section must be contained within an element for a collapsible row, with the summary text being 'Customize Your Product.'
    
    1. Input Form Field and Data Persistence: Include a required, multi-line <textarea> input field for customer personalization. This text box must function as a line item property named properties to ensure data persistence to the cart. Set the field height to 5 rows and include a descriptive placeholder text. Crucially, the customer must be able to press enter to create new lines of text.
    
    2. Mockup Display and Data Sourcing: Position a product mockup display adjacent to the input field on desktop (and stacked on mobile) using appropriate responsive HTML/CSS structure. The image source for this mockup must be dynamically pulled from the product's metafield using the namespace custom and key mockup_image. Use the Liquid image_url filter and include a necessary Liquid conditional check (if) and fallback if the metafield is empty.
    
    3. Text Overlay and Centering: Create a dynamically updated text overlay positioned absolutely over the entire area of the mockup image. This overlay must display the text entered by the customer in the textarea. The text overlay must be styled using CSS Flexbox properties (display: flex, align-items: center, justify-content: center) to achieve perfect horizontal and vertical centering over the image. The text within the overlay must also use text-align: center and must wrap lines appropriately.
    
    4. CSS Optimizations: Ensure the preview text overlay container uses the CSS properties white-space: pre-line and appropriate sizing/color settings for legibility against the mockup image.
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-personalization-preview-{{ ai_gen_id }} {
    width: 100%;
  }

  .ai-personalization-summary-{{ ai_gen_id }} {
    cursor: pointer;
    padding: 16px 20px;
    background-color: {{ block.settings.summary_bg_color }};
    border: {{ block.settings.border_thickness }}px solid {{ block.settings.border_color }};
    border-radius: {{ block.settings.border_radius }}px;
    font-size: {{ block.settings.summary_font_size }}px;
    font-weight: 600;
    color: {{ block.settings.summary_text_color }};
    list-style: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .ai-personalization-summary-{{ ai_gen_id }}::-webkit-details-marker {
    display: none;
  }

  .ai-personalization-summary-{{ ai_gen_id }}::marker {
    display: none;
  }

  .ai-personalization-icon-{{ ai_gen_id }} {
    transition: transform 0.3s ease;
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }

  .ai-personalization-details-{{ ai_gen_id }}[open] .ai-personalization-icon-{{ ai_gen_id }} {
    transform: rotate(180deg);
  }

  .ai-personalization-content-{{ ai_gen_id }} {
    padding: 24px 20px;
    border: {{ block.settings.border_thickness }}px solid {{ block.settings.border_color }};
    border-top: none;
    border-radius: 0 0 {{ block.settings.border_radius }}px {{ block.settings.border_radius }}px;
  }

  .ai-personalization-grid-{{ ai_gen_id }} {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }

  @media screen and (min-width: 750px) {
    .ai-personalization-grid-{{ ai_gen_id }} {
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }
  }

  .ai-personalization-input-wrapper-{{ ai_gen_id }} {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .ai-personalization-label-{{ ai_gen_id }} {
    font-size: {{ block.settings.label_font_size }}px;
    font-weight: 600;
    color: {{ block.settings.label_color }};
  }

  .ai-personalization-textarea-{{ ai_gen_id }} {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid {{ block.settings.input_border_color }};
    border-radius: {{ block.settings.input_border_radius }}px;
    font-size: {{ block.settings.input_font_size }}px;
    font-family: inherit;
    resize: vertical;
    min-height: 120px;
  }

  .ai-personalization-textarea-{{ ai_gen_id }}:focus {
    outline: 2px solid {{ block.settings.input_focus_color }};
    outline-offset: 2px;
  }

  .ai-personalization-mockup-wrapper-{{ ai_gen_id }} {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ai-personalization-mockup-container-{{ ai_gen_id }} {
    position: relative;
    width: 100%;
    max-width: 500px;
  }

  .ai-personalization-mockup-image-{{ ai_gen_id }} {
    width: 100%;
    height: auto;
    display: block;
    border-radius: {{ block.settings.mockup_border_radius }}px;
  }

  .ai-personalization-placeholder-{{ ai_gen_id }} {
    width: 100%;
    aspect-ratio: 1 / 1;
    background-color: #f4f4f4;
    border-radius: {{ block.settings.mockup_border_radius }}px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ai-personalization-placeholder-{{ ai_gen_id }} svg {
    width: 100%;
    height: 100%;
    max-width: 200px;
    max-height: 200px;
    opacity: 0.3;
  }

  .ai-personalization-overlay-{{ ai_gen_id }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    pointer-events: none;
  }

  .ai-personalization-overlay-text-{{ ai_gen_id }} {
    font-size: {{ block.settings.overlay_font_size }}px;
    color: {{ block.settings.overlay_text_color }};
    text-align: center;
    white-space: pre-line;
    word-wrap: break-word;
    max-width: 100%;
    font-weight: {{ block.settings.overlay_font_weight }};
    text-shadow: {{ block.settings.text_shadow_x }}px {{ block.settings.text_shadow_y }}px {{ block.settings.text_shadow_blur }}px {{ block.settings.text_shadow_color }};
  }

  .ai-personalization-empty-state-{{ ai_gen_id }} {
    font-size: 14px;
    color: #999;
    font-style: italic;
  }
{% endstyle %}

<personalization-preview-{{ ai_gen_id }} {{ block.shopify_attributes }}>
  <details class="ai-personalization-details-{{ ai_gen_id }}">
    <summary class="ai-personalization-summary-{{ ai_gen_id }}">
      <span>{{ block.settings.summary_text }}</span>
      <svg class="ai-personalization-icon-{{ ai_gen_id }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </summary>
    
    <div class="ai-personalization-content-{{ ai_gen_id }}">
      <div class="ai-personalization-grid-{{ ai_gen_id }}">
        <div class="ai-personalization-input-wrapper-{{ ai_gen_id }}">
          <label for="personalization-text-{{ ai_gen_id }}" class="ai-personalization-label-{{ ai_gen_id }}">
            {{ block.settings.input_label }}
          </label>
          <textarea
            id="personalization-text-{{ ai_gen_id }}"
            name="properties[{{ block.settings.property_name }}]"
            class="ai-personalization-textarea-{{ ai_gen_id }}"
            rows="5"
            placeholder="{{ block.settings.placeholder_text }}"
            required
            data-preview-target
          ></textarea>
        </div>

        <div class="ai-personalization-mockup-wrapper-{{ ai_gen_id }}">
          <div class="ai-personalization-mockup-container-{{ ai_gen_id }}">
            {% if product.metafields.custom.mockup_image %}
              <img
                src="{{ product.metafields.custom.mockup_image | image_url: width: 1000 }}"
                alt="{{ block.settings.mockup_alt_text }}"
                class="ai-personalization-mockup-image-{{ ai_gen_id }}"
                loading="lazy"
                width="1000"
                height="1000"
              >
            {% else %}
              <div class="ai-personalization-placeholder-{{ ai_gen_id }}">
                {{ 'product-1' | placeholder_svg_tag }}
              </div>
            {% endif %}
            
            <div class="ai-personalization-overlay-{{ ai_gen_id }}">
              <div class="ai-personalization-overlay-text-{{ ai_gen_id }}" data-preview-display>
                <span class="ai-personalization-empty-state-{{ ai_gen_id }}">{{ block.settings.empty_state_text }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </details>
</personalization-preview-{{ ai_gen_id }}>

<script>
  (function() {
    class PersonalizationPreview{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
      }

      connectedCallback() {
        this.textarea = this.querySelector('[data-preview-target]');
        this.previewDisplay = this.querySelector('[data-preview-display]');
        this.emptyState = this.querySelector('.ai-personalization-empty-state-{{ ai_gen_id }}');
        
        if (this.textarea && this.previewDisplay) {
          this.textarea.addEventListener('input', this.updatePreview.bind(this));
        }
      }

      updatePreview() {
        const text = this.textarea.value;
        
        if (text.trim() === '') {
          this.previewDisplay.innerHTML = '<span class="ai-personalization-empty-state-{{ ai_gen_id }}">{{ block.settings.empty_state_text }}</span>';
        } else {
          this.previewDisplay.textContent = text;
        }
      }
    }

    customElements.define('personalization-preview-{{ ai_gen_id }}', PersonalizationPreview{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Personalization preview",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Collapsible section"
    },
    {
      "type": "text",
      "id": "summary_text",
      "label": "Summary text",
      "default": "Customize Your Product"
    },
    {
      "type": "range",
      "id": "summary_font_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Summary font size",
      "default": 16
    },
    {
      "type": "color",
      "id": "summary_bg_color",
      "label": "Summary background",
      "default": "#f4f4f4"
    },
    {
      "type": "color",
      "id": "summary_text_color",
      "label": "Summary text color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "border_thickness",
      "min": 0,
      "max": 4,
      "step": 1,
      "unit": "px",
      "label": "Border thickness",
      "default": 1
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#e0e0e0"
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Border radius",
      "default": 6
    },
    {
      "type": "header",
      "content": "Input field"
    },
    {
      "type": "text",
      "id": "input_label",
      "label": "Input label",
      "default": "Your personalization text"
    },
    {
      "type": "text",
      "id": "property_name",
      "label": "Property name",
      "default": "Personalization"
    },
    {
      "type": "textarea",
      "id": "placeholder_text",
      "label": "Placeholder text",
      "default": "Enter your custom text here..."
    },
    {
      "type": "range",
      "id": "label_font_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Label font size",
      "default": 14
    },
    {
      "type": "color",
      "id": "label_color",
      "label": "Label color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "input_font_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Input font size",
      "default": 14
    },
    {
      "type": "color",
      "id": "input_border_color",
      "label": "Input border color",
      "default": "#cccccc"
    },
    {
      "type": "color",
      "id": "input_focus_color",
      "label": "Input focus color",
      "default": "#1f9393"
    },
    {
      "type": "range",
      "id": "input_border_radius",
      "min": 0,
      "max": 12,
      "step": 2,
      "unit": "px",
      "label": "Input border radius",
      "default": 6
    },
    {
      "type": "header",
      "content": "Mockup display"
    },
    {
      "type": "text",
      "id": "mockup_alt_text",
      "label": "Mockup alt text",
      "default": "Product personalization preview"
    },
    {
      "type": "range",
      "id": "mockup_border_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Mockup border radius",
      "default": 6
    },
    {
      "type": "header",
      "content": "Text overlay"
    },
    {
      "type": "text",
      "id": "empty_state_text",
      "label": "Empty state text",
      "default": "Your text will appear here"
    },
    {
      "type": "range",
      "id": "overlay_font_size",
      "min": 12,
      "max": 48,
      "step": 2,
      "unit": "px",
      "label": "Overlay font size",
      "default": 20
    },
    {
      "type": "color",
      "id": "overlay_text_color",
      "label": "Overlay text color",
      "default": "#000000"
    },
    {
      "type": "select",
      "id": "overlay_font_weight",
      "label": "Overlay font weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "600",
          "label": "Semi-bold"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "600"
    },
    {
      "type": "header",
      "content": "Text shadow"
    },
    {
      "type": "range",
      "id": "text_shadow_x",
      "min": -5,
      "max": 5,
      "step": 1,
      "unit": "px",
      "label": "Horizontal offset",
      "default": 1
    },
    {
      "type": "range",
      "id": "text_shadow_y",
      "min": -5,
      "max": 5,
      "step": 1,
      "unit": "px",
      "label": "Vertical offset",
      "default": 1
    },
    {
      "type": "range",
      "id": "text_shadow_blur",
      "min": 0,
      "max": 10,
      "step": 1,
      "unit": "px",
      "label": "Blur",
      "default": 2
    },
    {
      "type": "color",
      "id": "text_shadow_color",
      "label": "Shadow color",
      "default": "#ffffff"
    }
  ],
  "presets": [
    {
      "name": "Personalization preview"
    }
  ]
}
{% endschema %}